// ========== ìë™ ë‰´ìŠ¤ë ˆí„° with êµ¬ë… ì‹œìŠ¤í…œ ==========
// ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 10ì‹œì— êµ¬ë…ì ì „ì²´ì—ê²Œ Telegramìœ¼ë¡œ ë‰´ìŠ¤ ì „ì†¡
// 
// ê¸°ëŠ¥:
// - /subscribe: ë‰´ìŠ¤ë ˆí„° êµ¬ë…
// - /unsubscribe: êµ¬ë… ì·¨ì†Œ
// - /status: êµ¬ë… ìƒíƒœ í™•ì¸
// - /stats: êµ¬ë…ì ìˆ˜ í™•ì¸ (ê´€ë¦¬ìë§Œ)

// ========== ì—¬ê¸°ì— ë‹¹ì‹ ì˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš” ==========
const TELEGRAM_BOT_TOKEN = â€˜##â€™;
const CLAUDE_API_KEY = â€˜##â€™;
const ADMIN_CHAT_ID = â€˜##â€™;

// Google Sheets ID (ë‚˜ì¤‘ì— ì…ë ¥)
// Sheets URLì—ì„œ /d/ ë‹¤ìŒ ë¶€ë¶„ì„ ë³µì‚¬: 
// https://docs.google.com/spreadsheets/d/ì—¬ê¸°_ë¶€ë¶„_ë³µì‚¬/edit
const SPREADSHEET_ID = â€˜##â€™;
// ====================================================

// ========== ë‰´ìŠ¤ ì„¤ì • ==========
const NEWS_CATEGORIES = {
  international: {
    primary: ['ê²½ì œ', 'ë¹„ì¦ˆë‹ˆìŠ¤', 'ê¸ˆìœµ', 'ê¸°ì—…', 'economy', 'business', 'stock', 'finance', 'AI', 'IT', 'Technology'],
    secondary: ['ì •ì¹˜', 'ì™¸êµ', 'êµ­ì œê´€ê³„', 'politics', 'diplomacy', 'war', 'trade']
  },
  domestic: {
    primary: ['ê²½ì œ', 'ë¶€ë™ì‚°', 'ì£¼ì‹', 'ê¸ˆìœµ'],
    secondary: ['ë¬¸í™”', 'ì—”í„°í…Œì¸ë¨¼íŠ¸', 'IT', 'ê¸°ìˆ '],
    tertiary: ['ì •ì¹˜', 'ì‚¬íšŒ']
  }
};

const MAX_ITEMS_PER_CATEGORY = 10;
// ====================================================

/**
 * ========== êµ¬ë… ê´€ë¦¬ í•¨ìˆ˜ë“¤ ==========
 */

/**
 * Telegram Webhook ì„¤ì • (í•œ ë²ˆë§Œ ì‹¤í–‰)
 */
function setWebhook() {
  const url = ScriptApp.getService().getUrl();
  const telegramUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/setWebhook`;
  
  const payload = {
    url: url
  };
  
  try {
    const response = UrlFetchApp.fetch(telegramUrl, {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload)
    });
    
    Logger.log('Webhook ì„¤ì • ì™„ë£Œ: ' + response.getContentText());
    return true;
  } catch (error) {
    Logger.log('Webhook ì„¤ì • ì˜¤ë¥˜: ' + error.message);
    return false;
  }
}

/**
 * Webhookìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ë©”ì‹œì§€ ì²˜ë¦¬
 */
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    if (data.message) {
      const chatId = data.message.chat.id.toString();
      const text = data.message.text;
      const username = data.message.from.username || 'ìµëª…';
      const firstName = data.message.from.first_name || '';
      
      Logger.log(`ë©”ì‹œì§€ ìˆ˜ì‹ : ${text} from ${chatId}`);
      
      // ëª…ë ¹ì–´ ì²˜ë¦¬
      if (text.startsWith('/')) {
        handleCommand(text, chatId, username, firstName);
      }
    }
    
    return ContentService.createTextOutput(JSON.stringify({status: 'ok'}))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    Logger.log('doPost ì˜¤ë¥˜: ' + error.message);
    return ContentService.createTextOutput(JSON.stringify({status: 'error'}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * ëª…ë ¹ì–´ ì²˜ë¦¬
 */
function handleCommand(command, chatId, username, firstName) {
  const cmd = command.split(' ')[0].toLowerCase();
  
  switch(cmd) {
    case '/start':
      sendTelegramMessage(chatId, getWelcomeMessage());
      break;
      
    case '/subscribe':
      handleSubscribe(chatId, username, firstName);
      break;
      
    case '/unsubscribe':
      handleUnsubscribe(chatId);
      break;
      
    case '/status':
      handleStatus(chatId);
      break;
      
    case '/stats':
      handleStats(chatId);
      break;
      
    case '/help':
      sendTelegramMessage(chatId, getHelpMessage());
      break;
      
    default:
      sendTelegramMessage(chatId, 'ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤. /helpë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
  }
}

/**
 * í™˜ì˜ ë©”ì‹œì§€
 */
function getWelcomeMessage() {
  return `ğŸ“° ì£¼ê°„ ë‰´ìŠ¤ë ˆí„° ë´‡ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!

ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9-10ì‹œì— ì—„ì„ ëœ ë‰´ìŠ¤ë¥¼ ë°›ì•„ë³´ì„¸ìš”.

ğŸ”” êµ¬ë…í•˜ë ¤ë©´: /subscribe
âŒ êµ¬ë… ì·¨ì†Œ: /unsubscribe
ğŸ“Š êµ¬ë… ìƒíƒœ: /status`;
}

/**
 * ë„ì›€ë§ ë©”ì‹œì§€
 */
function getHelpMessage() {
  return `ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:

/subscribe - ë‰´ìŠ¤ë ˆí„° êµ¬ë… ì‹œì‘
/unsubscribe - ë‰´ìŠ¤ë ˆí„° êµ¬ë… ì·¨ì†Œ
/status - í˜„ì¬ êµ¬ë… ìƒíƒœ í™•ì¸
/help - ì´ ë„ì›€ë§ ë³´ê¸°

ğŸ“° ë‰´ìŠ¤ë ˆí„° ì •ë³´:
â€¢ ë°œì†¡: ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9-10ì‹œ
â€¢ ë‚´ìš©: êµ­ì œ/êµ­ë‚´ ê²½ì œ, ì •ì¹˜, ë¬¸í™” ë‰´ìŠ¤
â€¢ ì„ ì • ê¸°ì¤€: ê²½ì œ ì˜í–¥ë ¥, ê¸´ê¸‰ì„±, ì •ë³´ ê°€ì¹˜, ì‹¤ìš©ì„±

ë‰´ìŠ¤ëŠ” AIê°€ ì—„ì„ í•œ ì¤‘ìš”í•œ ë‚´ìš©ë§Œ í¬í•¨ë©ë‹ˆë‹¤.`;
}

/**
 * êµ¬ë… ì²˜ë¦¬
 */
function handleSubscribe(chatId, username, firstName) {
  const sheet = getSubscribersSheet();
  const data = sheet.getDataRange().getValues();
  
  // ì´ë¯¸ êµ¬ë… ì¤‘ì¸ì§€ í™•ì¸
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === chatId) {
      sendTelegramMessage(chatId, 'âœ… ì´ë¯¸ êµ¬ë… ì¤‘ì…ë‹ˆë‹¤!\n\në§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ì— ë‰´ìŠ¤ë ˆí„°ë¥¼ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      return;
    }
  }
  
  // ìƒˆ êµ¬ë…ì ì¶”ê°€
  const timestamp = new Date();
  sheet.appendRow([chatId, username, firstName, timestamp, 'active']);
  
  const message = `ğŸ‰ êµ¬ë…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!

ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9-10ì‹œì— ì—„ì„ ëœ ë‰´ìŠ¤ë ˆí„°ë¥¼ ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

êµ¬ë…ì„ ì·¨ì†Œí•˜ë ¤ë©´ /unsubscribeë¥¼ ì…ë ¥í•˜ì„¸ìš”.`;
  
  sendTelegramMessage(chatId, message);
  
  // ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼
  if (ADMIN_CHAT_ID && ADMIN_CHAT_ID !== 'ì—¬ê¸°ì—_ê´€ë¦¬ì_Chat_ID_ì…ë ¥') {
    const adminMessage = `ğŸ†• ìƒˆ êµ¬ë…ì\n\nì´ë¦„: ${firstName}\nì•„ì´ë””: @${username}\nChat ID: ${chatId}\nì‹œê°„: ${timestamp}`;
    sendTelegramMessage(ADMIN_CHAT_ID, adminMessage);
  }
  
  Logger.log(`ìƒˆ êµ¬ë…ì: ${chatId} (${username})`);
}

/**
 * êµ¬ë… ì·¨ì†Œ ì²˜ë¦¬
 */
function handleUnsubscribe(chatId) {
  const sheet = getSubscribersSheet();
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === chatId) {
      sheet.deleteRow(i + 1);
      sendTelegramMessage(chatId, 'ğŸ‘‹ êµ¬ë…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\në‹¤ì‹œ êµ¬ë…í•˜ë ¤ë©´ /subscribeë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      Logger.log(`êµ¬ë… ì·¨ì†Œ: ${chatId}`);
      return;
    }
  }
  
  sendTelegramMessage(chatId, 'âŒ êµ¬ë… ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.\n\nêµ¬ë…í•˜ë ¤ë©´ /subscribeë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
}

/**
 * êµ¬ë… ìƒíƒœ í™•ì¸
 */
function handleStatus(chatId) {
  const sheet = getSubscribersSheet();
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === chatId) {
      const subscribeDate = new Date(data[i][3]);
      const dateStr = Utilities.formatDate(subscribeDate, 'GMT+9', 'yyyyë…„ Mì›” dì¼ HH:mm');
      
      const message = `ğŸ“Š êµ¬ë… ìƒíƒœ

âœ… êµ¬ë… ì¤‘
ğŸ“… êµ¬ë… ì‹œì‘: ${dateStr}
ğŸ”” ë‹¤ìŒ ë°œì†¡: ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 10ì‹œ

êµ¬ë…ì„ ì·¨ì†Œí•˜ë ¤ë©´ /unsubscribeë¥¼ ì…ë ¥í•˜ì„¸ìš”.`;
      
      sendTelegramMessage(chatId, message);
      return;
    }
  }
  
  sendTelegramMessage(chatId, 'âŒ êµ¬ë… ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.\n\nêµ¬ë…í•˜ë ¤ë©´ /subscribeë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
}

/**
 * í†µê³„ í™•ì¸ (ê´€ë¦¬ìë§Œ)
 */
function handleStats(chatId) {
  if (chatId !== ADMIN_CHAT_ID) {
    sendTelegramMessage(chatId, 'âŒ ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤.');
    return;
  }
  
  const sheet = getSubscribersSheet();
  const data = sheet.getDataRange().getValues();
  const totalSubscribers = data.length - 1; // í—¤ë” ì œì™¸
  
  // ìµœê·¼ êµ¬ë…ì 5ëª…
  const recentSubscribers = [];
  for (let i = Math.max(1, data.length - 5); i < data.length; i++) {
    const username = data[i][1] || 'ìµëª…';
    const firstName = data[i][2] || '';
    const date = Utilities.formatDate(new Date(data[i][3]), 'GMT+9', 'M/d HH:mm');
    recentSubscribers.push(`â€¢ ${firstName} (@${username}) - ${date}`);
  }
  
  const message = `ğŸ“Š êµ¬ë…ì í†µê³„

ğŸ‘¥ ì´ êµ¬ë…ì: ${totalSubscribers}ëª…

ğŸ“… ìµœê·¼ êµ¬ë…ì:
${recentSubscribers.reverse().join('\n')}`;
  
  sendTelegramMessage(chatId, message);
}

/**
 * Google Sheets ê°€ì ¸ì˜¤ê¸°
 */
function getSubscribersSheet() {
  const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = spreadsheet.getSheetByName('Subscribers');
  
  // ì‹œíŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„±
  if (!sheet) {
    sheet = spreadsheet.insertSheet('Subscribers');
    sheet.appendRow(['Chat ID', 'Username', 'First Name', 'Subscribe Date', 'Status']);
    sheet.setFrozenRows(1);
  }
  
  return sheet;
}

/**
 * ëª¨ë“  êµ¬ë…ì Chat ID ê°€ì ¸ì˜¤ê¸°
 */
function getAllSubscribers() {
  const sheet = getSubscribersSheet();
  const data = sheet.getDataRange().getValues();
  const subscribers = [];
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][4] === 'active') {
      subscribers.push(data[i][0]); // Chat ID
    }
  }
  
  return subscribers;
}

/**
 * ========== ë‰´ìŠ¤ë ˆí„° ì „ì†¡ í•¨ìˆ˜ë“¤ ==========
 */

/**
 * ë©”ì¸ í•¨ìˆ˜: ì£¼ê°„ ë‰´ìŠ¤ë ˆí„° ì „ì†¡ (ëª¨ë“  êµ¬ë…ìì—ê²Œ)
 */
function sendWeeklyNewsletter() {
  try {
    Logger.log('=== ë‰´ìŠ¤ë ˆí„° ìƒì„± ì‹œì‘ ===');
    
    // 1. êµ¬ë…ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const subscribers = getAllSubscribers();
    
    if (subscribers.length === 0) {
      Logger.log('êµ¬ë…ìê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    Logger.log(`êµ¬ë…ì ìˆ˜: ${subscribers.length}ëª…`);
    
    // 2. ë‰´ìŠ¤ ìˆ˜ì§‘
    const newsData = collectNews();
    
    // 3. Claude APIë¡œ ë‰´ìŠ¤ ìš”ì•½ ë° ì •ë¦¬
    const newsletter = generateNewsletterWithClaude(newsData);
    
    // 4. ëª¨ë“  êµ¬ë…ìì—ê²Œ ì „ì†¡
    let successCount = 0;
    let failCount = 0;
    
    subscribers.forEach((chatId, index) => {
      try {
        Utilities.sleep(100); // API ì œí•œ ë°©ì§€ (100ms ëŒ€ê¸°)
        sendTelegramMessage(chatId, newsletter);
        successCount++;
        Logger.log(`ì „ì†¡ ì„±ê³µ: ${chatId} (${index + 1}/${subscribers.length})`);
      } catch (error) {
        failCount++;
        Logger.log(`ì „ì†¡ ì‹¤íŒ¨: ${chatId} - ${error.message}`);
      }
    });
    
    // 5. ê´€ë¦¬ìì—ê²Œ ê²°ê³¼ ë³´ê³ 
    if (ADMIN_CHAT_ID && ADMIN_CHAT_ID !== 'ì—¬ê¸°ì—_ê´€ë¦¬ì_Chat_ID_ì…ë ¥') {
      const report = `ğŸ“Š ë‰´ìŠ¤ë ˆí„° ë°œì†¡ ì™„ë£Œ\n\nâœ… ì„±ê³µ: ${successCount}ëª…\nâŒ ì‹¤íŒ¨: ${failCount}ëª…\nì´: ${subscribers.length}ëª…`;
      sendTelegramMessage(ADMIN_CHAT_ID, report);
    }
    
    Logger.log('=== ë‰´ìŠ¤ë ˆí„° ì „ì†¡ ì™„ë£Œ ===');
    Logger.log(`ì„±ê³µ: ${successCount}, ì‹¤íŒ¨: ${failCount}`);
    
  } catch (error) {
    Logger.log('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
    
    if (ADMIN_CHAT_ID && ADMIN_CHAT_ID !== 'ì—¬ê¸°ì—_ê´€ë¦¬ì_Chat_ID_ì…ë ¥') {
      sendTelegramMessage(ADMIN_CHAT_ID, `âš ï¸ ë‰´ìŠ¤ë ˆí„° ìƒì„± ì˜¤ë¥˜\n\n${error.message}`);
    }
  }
}

/**
 * ë‰´ìŠ¤ ìˆ˜ì§‘ í•¨ìˆ˜
 */
function collectNews() {
  const today = new Date();
  const dateStr = Utilities.formatDate(today, 'GMT+9', 'yyyyë…„ Mì›” dì¼');
  
  Logger.log('ë‰´ìŠ¤ ìˆ˜ì§‘ ì¤‘...');
  
  const newsData = {
    date: dateStr,
    international: {
      economy: searchNews('international economy business news', MAX_ITEMS_PER_CATEGORY),
      politics: searchNews('international politics diplomacy news', MAX_ITEMS_PER_CATEGORY)
    },
    domestic: {
      economy: searchNews('í•œêµ­ ê²½ì œ ê¸ˆìœµ ë‰´ìŠ¤', MAX_ITEMS_PER_CATEGORY),
      culture: searchNews('í•œêµ­ ë¬¸í™” IT ê¸°ìˆ  ë‰´ìŠ¤', MAX_ITEMS_PER_CATEGORY),
      politics: searchNews('í•œêµ­ ì •ì¹˜ ì‚¬íšŒ ë‰´ìŠ¤', MAX_ITEMS_PER_CATEGORY)
    }
  };
  
  return newsData;
}

/**
 * êµ¬ê¸€ ë‰´ìŠ¤ ê²€ìƒ‰
 */
function searchNews(query, maxResults) {
  try {
    const encodedQuery = encodeURIComponent(query);
    const rssUrl = `https://news.google.com/rss/search?q=${encodedQuery}&hl=ko&gl=KR&ceid=KR:ko`;
    
    const response = UrlFetchApp.fetch(rssUrl);
    const xml = response.getContentText();
    
    const document = XmlService.parse(xml);
    const root = document.getRootElement();
    const channel = root.getChild('channel');
    const items = channel.getChildren('item');
    
    const news = [];
    for (let i = 0; i < Math.min(items.length, maxResults); i++) {
      const item = items[i];
      news.push({
        title: item.getChildText('title'),
        link: item.getChildText('link'),
        pubDate: item.getChildText('pubDate'),
        source: item.getChildText('source') || 'ì¶œì²˜ ë¯¸ìƒ'
      });
    }
    
    return news;
    
  } catch (error) {
    Logger.log(`ë‰´ìŠ¤ ê²€ìƒ‰ ì˜¤ë¥˜ (${query}): ${error.message}`);
    return [];
  }
}

/**
 * Claude APIë¡œ ë‰´ìŠ¤ë ˆí„° ìƒì„±
 */
function generateNewsletterWithClaude(newsData) {
  Logger.log('Claudeë¡œ ë‰´ìŠ¤ ì—„ì„  ë° ìš”ì•½ ì¤‘...');
  
  const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ ë‰´ìŠ¤ íë ˆì´í„°ì…ë‹ˆë‹¤. ë‹¤ìŒ ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ì—„ê²©í•œ ê¸°ì¤€ìœ¼ë¡œ ì„ ë³„í•˜ê³  ê°„ê²°í•˜ê²Œ ìš”ì•½í•˜ì—¬ ì£¼ê°„ ë‰´ìŠ¤ë ˆí„°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ë‚ ì§œ: ${newsData.date}

=== ìˆ˜ì§‘ëœ ë‰´ìŠ¤ ===

## êµ­ì œ ë‰´ìŠ¤
### ê²½ì œ
${formatNewsForPrompt(newsData.international.economy)}

### ì •ì¹˜
${formatNewsForPrompt(newsData.international.politics)}

## êµ­ë‚´ ë‰´ìŠ¤
### ê²½ì œ
${formatNewsForPrompt(newsData.domestic.economy)}

### ë¬¸í™”/IT
${formatNewsForPrompt(newsData.domestic.culture)}

### ì •ì¹˜
${formatNewsForPrompt(newsData.domestic.politics)}

=== ë‰´ìŠ¤ ì„ ì • ê¸°ì¤€ ===
ë‹¤ìŒ 4ê°€ì§€ ê¸°ì¤€ì„ ì¶©ì¡±í•˜ëŠ” ë‰´ìŠ¤ë§Œ ì„ ì •:

1. ê²½ì œ ì˜í–¥ë ¥: êµ­ê°€ ê²½ì œ/ì‹œì¥ì— ì‹¤ì§ˆì  ì˜í–¥
2. ê¸´ê¸‰ì„±: ì˜¤ëŠ˜/ì´ë²ˆ ì£¼ ì•Œì•„ì•¼ í•  ì •ë³´
3. ì‹¤ìš©ì„±: ê°œì¸ ì¬ë¬´/íˆ¬ì ê²°ì •ì— ë„ì›€
4. ë²”ìš©ì„±: ë§ì€ ë§¤ì²´ì—ì„œ ì¤‘ë³µì ìœ¼ë¡œ ë‹¤ë¤„ì§€ëŠ” ì£¼ìš” ë‰´ìŠ¤ì¸ ê²½ìš°

=== ì‘ì„± ê°€ì´ë“œ ===
1. ê° ì¹´í…Œê³ ë¦¬ë³„ë¡œ ê°€ì¥ ì¤‘ìš”í•œ ë‰´ìŠ¤ 4-5ê°œ ì„ ë³„
2. ê° ë‰´ìŠ¤ëŠ” 1-2 ë¬¸ì¥ìœ¼ë¡œ í•µì‹¬ë§Œ ìš”ì•½
3. ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„± í–¥ìƒ
4. ì „ì²´ ê¸¸ì´ëŠ” Telegram ë©”ì‹œì§€ë¡œ ì½ê¸° í¸í•œ ì •ë„ë¡œ
5. ë‰´ìŠ¤ ì œëª© ë’¤ì— [ì¶œì²˜] í˜•ì‹ìœ¼ë¡œ ì–¸ë¡ ì‚¬ í‘œì‹œ
6. ì¤‘ìš”ë„: êµ­ì œê²½ì œ > êµ­ì œì •ì¹˜ > êµ­ë‚´ê²½ì œ > êµ­ë‚´ë¬¸í™” > êµ­ë‚´ì •ì¹˜
7. "**"ê°€ ì¤‘ë³µì ìœ¼ë¡œ í‘œì‹œë˜ì§€ ì•Šê²Œ í•˜ê¸°

ì œì™¸: ë‹¨ìˆœ ì£¼ê°€ ë“±ë½(ì‚¬íšŒì  ì‹œì‚¬ì ì´ ìˆëŠ” ì£¼ê°€ ë“±ë½ì€ ì œì™¸), í™ë³´ì„± ê¸°ì‚¬, 1ì£¼ ì´ìƒì˜ ë°˜ë³µ ë‰´ìŠ¤, ê°€ì‹­ì„±ì˜ ë‰´ìŠ¤

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ì„±:

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“° ì£¼ê°„ ë‰´ìŠ¤ë ˆí„°
${newsData.date}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸŒ êµ­ì œ ë‰´ìŠ¤

ğŸ’° ê²½ì œ
â€¢ [í•œ ì¤„ ìš”ì•½ + ì˜í–¥ë ¥ + ì¶œì²˜]

ğŸ› ì •ì¹˜
â€¢ [í•œ ì¤„ ìš”ì•½ + ì˜í–¥ë ¥ + ì¶œì²˜]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‡°ğŸ‡· êµ­ë‚´ ë‰´ìŠ¤

ğŸ’° ê²½ì œ
â€¢ [í•œ ì¤„ ìš”ì•½ + ì˜í–¥ë ¥ + ì¶œì²˜]

ğŸ¨ ì‚¬íšŒ
â€¢ [í•œ ì¤„ ìš”ì•½ + ì˜í–¥ë ¥ + ì¶œì²˜]

ğŸ› ì •ì¹˜
â€¢ [í•œ ì¤„ ìš”ì•½ + ì˜í–¥ë ¥ + ì¶œì²˜]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ ì´ë²ˆ ì£¼ í•µì‹¬:
[2-3ë¬¸ì¥ ì´í‰]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;

  try {
    const response = UrlFetchApp.fetch('https://api.anthropic.com/v1/messages', {
      method: 'post',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': CLAUDE_API_KEY,
        'anthropic-version': '2023-06-01'
      },
      payload: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2500,
        messages: [{
          role: 'user',
          content: prompt
        }]
      })
    });
    
    const result = JSON.parse(response.getContentText());
    return result.content[0].text;
    
  } catch (error) {
    Logger.log('Claude API ì˜¤ë¥˜: ' + error.message);
    return createBasicNewsletter(newsData);
  }
}

function formatNewsForPrompt(newsArray) {
  if (!newsArray || newsArray.length === 0) return '(ë‰´ìŠ¤ ì—†ìŒ)';
  return newsArray.map((news, i) => `${i + 1}. ${news.title} [${news.source}]`).join('\n');
}

function createBasicNewsletter(newsData) {
  let newsletter = `ğŸ“° ì£¼ê°„ ë‰´ìŠ¤ë ˆí„° (${newsData.date})\n\n`;
  newsletter += 'ğŸŒ êµ­ì œ ë‰´ìŠ¤\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’° ê²½ì œ\n';
  newsData.international.economy.slice(0, 3).forEach(news => {
    newsletter += `â€¢ ${news.title}\n`;
  });
  newsletter += '\nğŸ‡°ğŸ‡· êµ­ë‚´ ë‰´ìŠ¤\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¼ ê²½ì œ\n';
  newsData.domestic.economy.slice(0, 3).forEach(news => {
    newsletter += `â€¢ ${news.title}\n`;
  });
  return newsletter;
}

/**
 * Telegram ë©”ì‹œì§€ ì „ì†¡
 */
function sendTelegramMessage(chatId, message) {
  const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
  
  const payload = {
    chat_id: chatId,
    text: message,
    parse_mode: 'HTML',
    disable_web_page_preview: true
  };
  
  const response = UrlFetchApp.fetch(url, {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  });
  
  return response;
}

/**
 * ========== í…ŒìŠ¤íŠ¸ & ì„¤ì • í•¨ìˆ˜ë“¤ ==========
 */

/**
 * ì´ˆê¸° ì„¤ì • (í•œ ë²ˆë§Œ ì‹¤í–‰)
 */
function initialSetup() {
  Logger.log('=== ì´ˆê¸° ì„¤ì • ì‹œì‘ ===');
  
  // 1. Google Sheets ìƒì„±
  const sheet = getSubscribersSheet();
  Logger.log('âœ… Google Sheets ìƒì„± ì™„ë£Œ');
  
  // 2. Webhook ì„¤ì •
  const webhookResult = setWebhook();
  if (webhookResult) {
    Logger.log('âœ… Webhook ì„¤ì • ì™„ë£Œ');
  } else {
    Logger.log('âŒ Webhook ì„¤ì • ì‹¤íŒ¨');
  }
  
  // 3. ê´€ë¦¬ìë¥¼ ì²« êµ¬ë…ìë¡œ ì¶”ê°€
  if (ADMIN_CHAT_ID && ADMIN_CHAT_ID !== 'ì—¬ê¸°ì—_ê´€ë¦¬ì_Chat_ID_ì…ë ¥') {
    handleSubscribe(ADMIN_CHAT_ID, 'admin', 'Admin');
    Logger.log('âœ… ê´€ë¦¬ì êµ¬ë… ì¶”ê°€');
  }
  
  Logger.log('=== ì´ˆê¸° ì„¤ì • ì™„ë£Œ ===');
}

/**
 * í…ŒìŠ¤íŠ¸ ë‰´ìŠ¤ë ˆí„° ì „ì†¡ (ê´€ë¦¬ìì—ê²Œë§Œ)
 */
function sendTestNewsletter() {
  if (ADMIN_CHAT_ID === 'ì—¬ê¸°ì—_ê´€ë¦¬ì_Chat_ID_ì…ë ¥') {
    Logger.log('âŒ ADMIN_CHAT_IDë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”!');
    return;
  }
  
  const testMessage = `ğŸ“° í…ŒìŠ¤íŠ¸ ë‰´ìŠ¤ë ˆí„° (êµ¬ë… ì‹œìŠ¤í…œ)

âœ¨ êµ¬ë… ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤!

ğŸ”” ê¸°ëŠ¥:
â€¢ /subscribe - êµ¬ë… ì‹œì‘
â€¢ /unsubscribe - êµ¬ë… ì·¨ì†Œ
â€¢ /status - êµ¬ë… ìƒíƒœ
â€¢ /stats - í†µê³„ (ê´€ë¦¬ìë§Œ)

âœ… ë‹¤ìŒ ë‹¨ê³„:
1. ë´‡ì—ê²Œ /subscribe ì „ì†¡í•´ë³´ê¸°
2. sendWeeklyNewsletter() ì‹¤í–‰í•˜ì—¬ ì‹¤ì œ ë‰´ìŠ¤ í™•ì¸
3. íŠ¸ë¦¬ê±° ì„¤ì •
4. ì¹œêµ¬ë“¤ì—ê²Œ ë´‡ ê³µìœ !`;

  sendTelegramMessage(ADMIN_CHAT_ID, testMessage);
  Logger.log('í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ');
}

