// ========================================
// í…”ë ˆê·¸ë¨ ë‰´ìŠ¤ë ˆí„° ë´‡ (Google Apps Script)
// ========================================

// ========== ì„¤ì •ê°’ ==========
const CONFIG = {
  TELEGRAM_BOT_TOKEN: '##',
  CLAUDE_API_KEY: '##',
  ADMIN_CHAT_ID: '##single person',
  
  // Claude ì„¤ì •
  CLAUDE_MODEL: '##',
  CLAUDE_MAX_TOKENS: 2000,
  
  // ë‰´ìŠ¤ ìˆ˜ì§‘ ì„¤ì •
  MAX_ITEMS_PER_QUERY: 8,
  NEWS_DAYS_LIMIT: 7
};

// ========== ë‰´ìŠ¤ ê²€ìƒ‰ ì¿¼ë¦¬ ==========
const NEWS_QUERIES = {
  // êµ­ì œ ë‰´ìŠ¤
  international: {
    economy: 'global economy OR inflation OR interest rate OR stock OR stock market OR S&P500 OR NASDAQ OR investment OR venture capital OR M&A OR IPO -í•œêµ­ -korea',
    industry: 'AI OR semiconductor OR tech OR electric vehicle OR space OR energy OR biotech -í•œêµ­ -korea',
    policy: 'Fed OR central bank OR trade OR policy OR tariff OR sanction OR trump -í•œêµ­ -korea'
  },
  
  // êµ­ë‚´ ë‰´ìŠ¤
  domestic: {
    economy: 'í•œêµ­ ê²½ì œ OR GDP OR ë¬¼ê°€ OR ê¸ˆë¦¬ OR í™˜ìœ¨ OR ê²½ê¸°ì¹¨ì²´ OR ì†Œë¹„ìë¬¼ê°€ OR ì½”ìŠ¤í”¼ OR ì½”ìŠ¤ë‹¥ OR ì½”ìŠ¤í”¼ì§€ìˆ˜ OR ì£¼ì‹ OR ì¦ì‹œ OR íˆ¬ì OR ë²¤ì²˜ OR í•©ë³‘ OR ì¸ìˆ˜',
    industry: 'ë°˜ë„ì²´ OR ì‚¼ì„±ì „ì OR SKí•˜ì´ë‹‰ìŠ¤ OR ë°°í„°ë¦¬ OR AI OR ê¸°ìˆ  OR ë§ˆìš´ìë¡œ',
    policy: 'í•œêµ­ì€í–‰ OR ê¸°íšì¬ì •ë¶€ OR ê¸ˆìœµìœ„ OR ì •ì±… OR ê·œì œ OR ëŒ€ì¶œ OR ë¶€ë™ì‚° OR ì´ì¬ëª…'
  }
};

// ========== ì œì™¸ í‚¤ì›Œë“œ ==========

const EXCLUDE_KEYWORDS = [
  // ê´‘ê³ /í™ë³´
  'ê´‘ê³ ', 'ì´ë²¤íŠ¸', 'í• ì¸', 'í”„ë¡œëª¨ì…˜', 'í›„ì›', 'ì œê³µ',
  // ì—°ì˜ˆ/ìŠ¤í¬ì¸ 
  'ì—°ì˜ˆ', 'ìŠ¤í¬ì¸ ', 'ì¶•êµ¬', 'ì•¼êµ¬', 'ì•„ì´ëŒ', 'ë“œë¼ë§ˆ', 'ì˜í™” ê°œë´‰',
  // ë‚ ì”¨/ìƒí™œ
  'ë‚ ì”¨', 'ìš´ì„¸', 'ë¡œë˜',
  // ì €í’ˆì§ˆ ì‹ í˜¸
  'í´ë¦­', 'ì¶©ê²©', 'ê²½ì•…', 'ì•Œê³ ë³´ë‹ˆ', 'í˜„ì¬ ìƒí™©',
  // ë‹¨ìˆœ ì‹œì„¸
  'ë§ˆê° ì‹œì„¸', 'ì¢…ê°€'
];

// ==========================================
// ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
// ==========================================

/**
 * ë‰´ìŠ¤ë ˆí„° ìƒì„± ë° ì „ì†¡ (íŠ¸ë¦¬ê±°ì—ì„œ í˜¸ì¶œ)
 */
function sendNewsletter() {
  try {
    Logger.log('=== ë‰´ìŠ¤ë ˆí„° ìƒì„± ì‹œì‘ ===');
    
    // 1. ë‰´ìŠ¤ ìˆ˜ì§‘
    const newsData = collectAllNews();
    Logger.log('ë‰´ìŠ¤ ìˆ˜ì§‘ ì™„ë£Œ');
    
    // 2. Claudeë¡œ ë‰´ìŠ¤ë ˆí„° ìƒì„±
    const newsletter = generateNewsletterWithClaude(newsData);
    Logger.log('ë‰´ìŠ¤ë ˆí„° ìƒì„± ì™„ë£Œ');
    
    // 3. Telegram ì „ì†¡
    const result = sendTelegramMessage(CONFIG.ADMIN_CHAT_ID, newsletter);
    
    if (result.ok) {
      Logger.log('âœ… ë‰´ìŠ¤ë ˆí„° ì „ì†¡ ì„±ê³µ');
    } else {
      Logger.log('âŒ ì „ì†¡ ì‹¤íŒ¨: ' + result.description);
    }
    
  } catch (error) {
    Logger.log('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
    
    // ì˜¤ë¥˜ ì•Œë¦¼ ì „ì†¡
    sendTelegramMessage(
      CONFIG.ADMIN_CHAT_ID, 
      'âš ï¸ ë‰´ìŠ¤ë ˆí„° ìƒì„± ì˜¤ë¥˜\n\n' + error.message
    );
  }
}


// ==========================================
// ë‰´ìŠ¤ ìˆ˜ì§‘ í•¨ìˆ˜
// ==========================================

/**
 * ëª¨ë“  ì¹´í…Œê³ ë¦¬ ë‰´ìŠ¤ ìˆ˜ì§‘
 */
function collectAllNews() {
  const today = new Date();
  const dateStr = Utilities.formatDate(today, 'GMT+9', 'yyyyë…„ Mì›” dì¼');
  
  const newsData = {
    date: dateStr,
    
    international: {
      economy: searchGoogleNews(NEWS_QUERIES.international.economy),
      industry: searchGoogleNews(NEWS_QUERIES.international.industry),
      policy: searchGoogleNews(NEWS_QUERIES.international.policy)
    },
    
    domestic: {
      economy: searchGoogleNews(NEWS_QUERIES.domestic.economy),
      industry: searchGoogleNews(NEWS_QUERIES.domestic.industry),
      policy: searchGoogleNews(NEWS_QUERIES.domestic.policy)
    }
  };
  
  // ìˆ˜ì§‘ í†µê³„ ë¡œê·¸
  const intCount = Object.values(newsData.international).reduce((sum, arr) => sum + arr.length, 0);
  const domCount = Object.values(newsData.domestic).reduce((sum, arr) => sum + arr.length, 0);
  Logger.log(`ìˆ˜ì§‘ ì™„ë£Œ - êµ­ì œ: ${intCount}ê±´, êµ­ë‚´: ${domCount}ê±´`);
  
  return newsData;
}

/**
 * Google News RSS ê²€ìƒ‰
 */
function searchGoogleNews(query) {
  try {
    const encodedQuery = encodeURIComponent(query);
    const rssUrl = `https://news.google.com/rss/search?q=${encodedQuery}&hl=ko&gl=KR&ceid=KR:ko`;
    
    const response = UrlFetchApp.fetch(rssUrl, {
      muteHttpExceptions: true
    });
    
    if (response.getResponseCode() !== 200) {
      Logger.log(`RSS ì˜¤ë¥˜ (${query}): ${response.getResponseCode()}`);
      return [];
    }
    
    const xml = response.getContentText();
    const document = XmlService.parse(xml);
    const root = document.getRootElement();
    const channel = root.getChild('channel');
    const items = channel.getChildren('item');
    
    const newsItems = [];
    
    for (let i = 0; i < Math.min(items.length, CONFIG.MAX_ITEMS_PER_QUERY); i++) {
      const item = items[i];
      
      const title = item.getChildText('title') || '';
      const link = item.getChildText('link') || '';
      const pubDate = item.getChildText('pubDate') || '';
      const source = item.getChildText('source') || extractSource(title);
      
      // ìµœê·¼ Nì¼ ì´ë‚´ ë‰´ìŠ¤ë§Œ
      if (!isRecentNews(pubDate, CONFIG.NEWS_DAYS_LIMIT)) {
        continue;
      }
      
      // ì œì™¸ í‚¤ì›Œë“œ í•„í„°ë§
      if (shouldExclude(title)) {
        continue;
      }
      
      newsItems.push({
        title: cleanTitle(title),
        link: link,
        pubDate: formatDate(pubDate),
        source: source
      });
    }
    
    return newsItems;
    
  } catch (error) {
    Logger.log(`ê²€ìƒ‰ ì˜¤ë¥˜ (${query}): ${error.message}`);
    return [];
  }
}

/**
 * ìµœê·¼ ë‰´ìŠ¤ì¸ì§€ í™•ì¸
 */
function isRecentNews(pubDateStr, days) {
  try {
    const pubDate = new Date(pubDateStr);
    const now = new Date();
    const diffDays = (now - pubDate) / (1000 * 60 * 60 * 24);
    return diffDays <= days;
  } catch (e) {
    return true;
  }
}

/**
 * ì œì™¸ í‚¤ì›Œë“œ ì²´í¬
 */
function shouldExclude(title) {
  const lowerTitle = title.toLowerCase();
  return EXCLUDE_KEYWORDS.some(keyword => 
    lowerTitle.includes(keyword.toLowerCase())
  );
}

/**
 * ë‚ ì§œ í¬ë§·
 */
function formatDate(dateStr) {
  try {
    const date = new Date(dateStr);
    return Utilities.formatDate(date, 'GMT+9', 'M/d HH:mm');
  } catch (e) {
    return dateStr;
  }
}


// ==========================================
// Claude API í•¨ìˆ˜
// ==========================================

/**
 * Claudeë¡œ ë‰´ìŠ¤ë ˆí„° ìƒì„±
 */
function generateNewsletterWithClaude(newsData) {
  const prompt = buildPrompt(newsData);
  
  try {
    const response = UrlFetchApp.fetch('https://api.anthropic.com/v1/messages', {
      method: 'post',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': CONFIG.CLAUDE_API_KEY,
        'anthropic-version': '2023-06-01'
      },
      payload: JSON.stringify({
        model: CONFIG.CLAUDE_MODEL,
        max_tokens: CONFIG.CLAUDE_MAX_TOKENS,
        messages: [{
          role: 'user',
          content: prompt
        }]
      }),
      muteHttpExceptions: true
    });
    
    const result = JSON.parse(response.getContentText());
    
    if (response.getResponseCode() !== 200) {
      throw new Error(result.error?.message || 'API ì˜¤ë¥˜');
    }
    
    return result.content[0].text;
    
  } catch (error) {
    Logger.log('Claude API ì˜¤ë¥˜: ' + error.message);
    return createFallbackNewsletter(newsData);
  }
}

/**
 * Claude í”„ë¡¬í”„íŠ¸ ìƒì„±
 */
function buildPrompt(newsData) {
  return `ë‹¹ì‹ ì€ ì „ë¬¸ ë‰´ìŠ¤ íë ˆì´í„°ì…ë‹ˆë‹¤. ì•„ë˜ ë‰´ìŠ¤ë¥¼ ë¶„ì„í•˜ì—¬ íˆ¬ììì—ê²Œ ìœ ìš©í•œ ë‰´ìŠ¤ë ˆí„°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ë‚ ì§œ: ${newsData.date}

=== ìˆ˜ì§‘ëœ ë‰´ìŠ¤ ===

## ğŸŒ êµ­ì œ ë‰´ìŠ¤

### ê²½ì œ
${formatNewsArray(newsData.international.economy)}

### ì‚°ì—…/ê¸°ìˆ 
${formatNewsArray(newsData.international.industry)}

### ì •ì±…
${formatNewsArray(newsData.international.policy)}

## ğŸ‡°ğŸ‡· êµ­ë‚´ ë‰´ìŠ¤

### ê²½ì œ
${formatNewsArray(newsData.domestic.economy)}

### ì‚°ì—…/ê¸°ìˆ 
${formatNewsArray(newsData.domestic.industry)}

### ì •ì±…
${formatNewsArray(newsData.domestic.policy)}

=== ì‘ì„± ê°€ì´ë“œ ===

1. **ë‰´ìŠ¤ ì„ ì • ê¸°ì¤€** (4ê°€ì§€ ì¤‘ 2ê°œ ì´ìƒ ì¶©ì¡±):
   - ê²½ì œ/ì‹œì¥ì— ì‹¤ì§ˆì  ì˜í–¥
   - ì´ë²ˆ ì£¼ ì•Œì•„ì•¼ í•  ê¸´ê¸‰ ì •ë³´
   - íˆ¬ì ê²°ì •ì— ë„ì›€ë˜ëŠ” ì‹¤ìš©ì„±
   - ì—¬ëŸ¬ ë§¤ì²´ì—ì„œ ë‹¤ë£¨ëŠ” ì£¼ìš” ë‰´ìŠ¤

2. **í˜•ì‹ ìš”êµ¬ì‚¬í•­**:
   - ê° ì¹´í…Œê³ ë¦¬ë³„ ì¤‘ìš” ë‰´ìŠ¤ 3-4ê°œ ì„ ë³„
   - ê° ë‰´ìŠ¤ëŠ” 1-2ë¬¸ì¥ìœ¼ë¡œ í•µì‹¬ë§Œ ìš”ì•½
   - ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš©
   - Telegramì—ì„œ ì½ê¸° í¸í•œ ê¸¸ì´
   - **ëŠ” ì œì™¸í•  ê²ƒ

3. **ì œì™¸ ëŒ€ìƒ**:
   - ë‹¨ìˆœ ì£¼ê°€ ë“±ë½ (í° ì‹œì‚¬ì  ì—†ëŠ”)
   - í™ë³´ì„±/ê´‘ê³ ì„± ê¸°ì‚¬
   - 1ì£¼ ì´ìƒ ë°˜ë³µë˜ëŠ” ë‰´ìŠ¤
   - ê°€ì‹­ì„± ë‰´ìŠ¤

=== ì¶œë ¥ í˜•ì‹ ===

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š ë°ì¼ë¦¬ íˆ¬ì ë‰´ìŠ¤ë ˆí„°
${newsData.date}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸš¨ ì˜¤ëŠ˜ì˜ í•µì‹¬ (3ê°œ)
â€¢ [ê°€ì¥ ì¤‘ìš”í•œ ë‰´ìŠ¤ ìš”ì•½]
â€¢ [ë‘ ë²ˆì§¸ ì¤‘ìš” ë‰´ìŠ¤]
â€¢ [ì„¸ ë²ˆì§¸ ì¤‘ìš” ë‰´ìŠ¤]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸŒ êµ­ì œ

ğŸ’° ê²½ì œ/ë§ˆì¼“
â€¢ [ìš”ì•½] [ì¶œì²˜]

ğŸ­ ì‚°ì—…/ê¸°ìˆ 
â€¢ [ìš”ì•½] [ì¶œì²˜]

ğŸ› ì •ì±…
â€¢ [ìš”ì•½] [ì¶œì²˜]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‡°ğŸ‡· êµ­ë‚´

ğŸ’° ê²½ì œ/ë§ˆì¼“
â€¢ [ìš”ì•½] [ì¶œì²˜]

ğŸ­ ì‚°ì—…/ê¸°ìˆ 
â€¢ [ìš”ì•½] [ì¶œì²˜]

ğŸ› ì •ì±…
â€¢ [ìš”ì•½] [ì¶œì²˜]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;
}

/**
 * ë‰´ìŠ¤ ë°°ì—´ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
 */
function formatNewsArray(newsArray) {
  if (!newsArray || newsArray.length === 0) {
    return '(ìˆ˜ì§‘ëœ ë‰´ìŠ¤ ì—†ìŒ)';
  }
  
  return newsArray.map((news, i) => 
    `${i + 1}. ${news.title} [${news.source}] (${news.pubDate})`
  ).join('\n');
}

/**
 * Claude ì‹¤íŒ¨ì‹œ ê¸°ë³¸ ë‰´ìŠ¤ë ˆí„°
 */
function createFallbackNewsletter(newsData) {
  let text = `ğŸ“° ë‰´ìŠ¤ë ˆí„° (${newsData.date})\n\n`;
  text += 'âš ï¸ AI ìš”ì•½ ì‹¤íŒ¨ - ì›ë³¸ í—¤ë“œë¼ì¸\n\n';
  
  text += 'ğŸŒ êµ­ì œ\n';
  newsData.international.economy.slice(0, 3).forEach(n => {
    text += `â€¢ ${n.title}\n`;
  });
  
  text += '\nğŸ‡°ğŸ‡· êµ­ë‚´\n';
  newsData.domestic.economy.slice(0, 3).forEach(n => {
    text += `â€¢ ${n.title}\n`;
  });
  
  return text;
}


// ==========================================
// Telegram í•¨ìˆ˜
// ==========================================

/**
 * Telegram ë©”ì‹œì§€ ì „ì†¡
 */
function sendTelegramMessage(chatId, message) {
  const url = `https://api.telegram.org/bot${CONFIG.TELEGRAM_BOT_TOKEN}/sendMessage`;
  
  // ë©”ì‹œì§€ ê¸¸ì´ ì œí•œ (4096ì)
  const truncatedMessage = message.length > 4000 
    ? message.substring(0, 4000) + '\n\n... (ë©”ì‹œì§€ ì˜ë¦¼)'
    : message;
  
  const payload = {
    chat_id: chatId,
    text: truncatedMessage,
    parse_mode: 'HTML',
    disable_web_page_preview: true
  };
  
  try {
    const response = UrlFetchApp.fetch(url, {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    });
    
    return JSON.parse(response.getContentText());
    
  } catch (error) {
    Logger.log('Telegram ì „ì†¡ ì˜¤ë¥˜: ' + error.message);
    return { ok: false, description: error.message };
  }
}


// ==========================================
// í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
// ==========================================

/**
 * ë‰´ìŠ¤ ìˆ˜ì§‘ í…ŒìŠ¤íŠ¸
 */
function testNewsCollection() {
  Logger.log('=== ë‰´ìŠ¤ ìˆ˜ì§‘ í…ŒìŠ¤íŠ¸ ===');
  const newsData = collectAllNews();
  
  Logger.log('\n--- êµ­ì œ ê²½ì œ ---');
  newsData.international.economy.forEach(n => Logger.log(n.title));
  
  Logger.log('\n--- êµ­ë‚´ ê²½ì œ ---');
  newsData.domestic.economy.forEach(n => Logger.log(n.title));
}

/**
 * Telegram ì—°ê²° í…ŒìŠ¤íŠ¸
 */
function testTelegram() {
  const result = sendTelegramMessage(
    CONFIG.ADMIN_CHAT_ID,
    'âœ… í…”ë ˆê·¸ë¨ ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!\n\ní˜„ì¬ ì‹œê°„: ' + new Date().toLocaleString('ko-KR')
  );
  
  Logger.log('Telegram í…ŒìŠ¤íŠ¸: ' + JSON.stringify(result));
}

/**
 * ì „ì²´ í…ŒìŠ¤íŠ¸ (ë‰´ìŠ¤ë ˆí„° ìƒì„± ë° ì „ì†¡)
 */
function testFullNewsletter() {
  sendNewsletter();
}
/**
 * ì œëª© ì •ë¦¬ (ì¶œì²˜ ì œê±°)
 */
function cleanTitle(title) {
  return title.replace(/\s-\s[^-]+$/, '').trim();
}

/**
 * ì œëª©ì—ì„œ ì¶œì²˜ ì¶”ì¶œ
 */
function extractSource(title) {
  const match = title.match(/\s-\s([^-]+)$/);
  return match ? match[1].trim() : '';
}
